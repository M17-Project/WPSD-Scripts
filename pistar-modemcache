#!/bin/bash

sed -i "/ircddbgateway/c ircddbgateway = 20190621_W0CHP" /etc/pistar-release
sed -i "/dstarrepeater/c dstarrepeater = 20180911_W0CHP" /etc/pistar-release

logDateUTC=$(date -u +"%Y-%m-%d")
mmdvmHostLog="/var/log/pi-star/MMDVM-${logDateUTC}.log"

# give a bit of time for MMDVMHost to generate the info in the logs before caching...
while [ ! -f ${mmdvmHostLog} ]
do
    sleep 1
done
while [[ $( grep -c 'MMDVM protocol version' ${mmdvmHostLog} ) -eq 0 ]]
do
    sleep 1
done

mount -o remount,rw /

_FWver=$( grep 'MMDVM protocol version' ${mmdvmHostLog} | awk '{print $9}' | tail -1 )
_TCXO=$( grep -o '.*MHz' ${mmdvmHostLog} | tail -1 | rev | cut -d' ' -f 1 | rev )
if ! grep -q 'Firmware' /etc/pistar-release > /dev/null; then
    sed -i "/Hardware = /a Firmware = \nTCXO = " /etc/pistar-release
    sed -i "/Firmware/c Firmware = $_FWver" /etc/pistar-release
    # G4KLX MMDVM FW is 12.0000 MHz:
    if [ ${_FWver} = "MMDVM" ] ; then
	sed -i "/TCXO/c TCXO = 12.0000MHz" /etc/pistar-release
    else
	sed -i "/TCXO/c TCXO = $_TCXO" /etc/pistar-release
    fi
else
    sed -i "/Firmware/c Firmware = $_FWver" /etc/pistar-release
    if [ ${_FWver} = "MMDVM" ] ; then
        sed -i "/TCXO/c TCXO = 12.0000MHz" /etc/pistar-release
    else
        sed -i "/TCXO/c TCXO = $_TCXO" /etc/pistar-release
    fi
fi

countProcs=$(grep -c ^processor /proc/cpuinfo)
if ! grep -w 'ProcNum' /etc/pistar-release > /dev/null; then
    sed -i "/Hardware = /a ProcNum = ${countProcs} " /etc/pistar-release
else
    sed -i "/ProcNum/c ProcNum = ${countProcs}" /etc/pistar-release
fi

_MMDVMHostVer=`MMDVMHost -v | awk '{ print $3 }'`
sed -i "/MMDVMHost/c MMDVMHost = $_MMDVMHostVer" /etc/pistar-release

sed -i "/ircddbgateway/c ircddbgateway = 20190621_W0CHP" /etc/pistar-release
sed -i "/dstarrepeater/c dstarrepeater = 20180911_W0CHP" /etc/pistar-release

_KernelVer=`uname -r`
sed -i "/kernel/c kernel = $_KernelVer" /etc/pistar-release

# cleanup last line..
sed -i '${/^$/d}' /etc/pistar-release


