#!/bin/bash
######################################################
#                                                    #
#            WPSD Config Restore on Bootup           #
#                                                    #
######################################################

# Check we are root
if [ "$(id -u)" != "0" ]
then
        echo "This script must be run as root" 1>&2
        exit 1
fi

platform_info=$(/usr/local/sbin/.wpsd-platform-detect)
if [[ $platform_info =~ "Raspberry Pi 5" ]]; then
    is_raspberry_pi_5=true
else
    is_raspberry_pi_5=false
fi

if $is_raspberry_pi_5 ; then
    if [ ! -f /boot/firmware/WPSD_Config_*.zip ]; then
	exit 1
    fi
else
    if [ ! -f /boot/WPSD_Config_*.zip ]; then
	exit 1
    fi
fi

if [ ! -d /tmp/config_restore ]; then
	mkdir /tmp/config_restore
fi

if $is_raspberry_pi_5 ; then
    unzip -j /boot/firmwware/WPSD_Config_*.zip -d /tmp/config_restore/ 2>&1
else
    unzip -j /boot/WPSD_Config_*.zip -d /tmp/config_restore/ 2>&1
fi

wpsd-services fullstop 

rm -f /etc/dstar-radio.* 2>&1
mv -f /tmp/config_restore/ircddblocal.php /var/www/dashboard/config/ 2>&1
mv -f /tmp/config_restore/config.php /var/www/dashboard/config/ 2>&1
mv -f /tmp/config_restore/wpa_supplicant.conf /etc/wpa_supplicant/ 2>&1
mv -f /tmp/config_restore/* /etc/ 2>&1

/usr/local/sbin/nextion-driver-helper

timedatectl set-timezone `grep date /var/www/dashboard/config/config.php | grep -o "'.*'" | sed "s/'//g"`

/usr/local/sbin/.wpsd-sys-cache

rm -rf /boot/WPSD_Config_*.zip 2>&1
sync; sync; sync;
reboot

exit 0
