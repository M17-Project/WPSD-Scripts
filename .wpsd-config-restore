#!/bin/bash
######################################################
#                                                    #
#            WPSD Config Restore on Bootup           #
#                                                    #
######################################################

# Check we are root
if [ "$(id -u)" != "0" ]
then
        echo "This script must be run as root" 1>&2
        exit 1
fi

if [ ! -f /boot/WPSD_Config_*.zip ]; then
	exit 1
fi

# First lets make the working directory
if [ ! -d /tmp/config_restore ]; then
	mkdir /tmp/config_restore
fi

# Unpack the configs
unzip -j /boot/WPSD_Config_*.zip -d /tmp/config_restore/ 2>&1

# Stop the services
wpsd-services fullstop 

# Overwrite the configs
rm -f /etc/dstar-radio.* 2>&1
mv -f /tmp/config_restore/ircddblocal.php /var/www/dashboard/config/ 2>&1
mv -f /tmp/config_restore/config.php /var/www/dashboard/config/ 2>&1
mv -f /tmp/config_restore/wpa_supplicant.conf /etc/wpa_supplicant/ 2>&1
mv -f /tmp/config_restore/* /etc/ 2>&1

# Set the Timezone
timedatectl set-timezone `grep date /var/www/dashboard/config/config.php | grep -o "'.*'" | sed "s/'//g"`

# Clean up
rm -rf /boot/WPSD_Config_*.zip 2>&1
sync; sync; sync;
reboot

exit 0
